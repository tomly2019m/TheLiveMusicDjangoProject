class LiveMusicWebsocket{constructor(t,e,s){this.vm=t,this.extend=e,this.group_id=s,this.random_num=Math.random(),this.ws_url=`${"http:"===window.location.protocol?"ws:":"wss:"}//${window.location.hostname}${window.location.port?":"+window.location.port:""}/ws/`+s,this.create_connection(this.ws_url)}create_connection(t){this.ws=new WebSocket(t),this.on_open(),this.on_close(),this.on_error(),this.on_message()}on_open(){this.ws.onopen=()=>{console.log("已连接"),this.vm.$data.information="已连接",setTimeout(()=>{this.vm.$data.information_mask=!1,this.vm.$data.now_view=0===this.vm.$data.who_i_am?"music_name":"music_lyric"},1e3),setTimeout(()=>{this.connectivity_test_console_send()},5e3),this.heartbeat_id=setInterval(()=>{this.send_heartbeat(),this.connectivity_test_console_send()},2e4)}}on_close(){this.ws.onclose=()=>{clearInterval(this.heartbeat_id),console.log("连接断开"),console.log("连接断开，尝试重连"),setTimeout(()=>{this.create_connection(this.ws_url)},2e3)}}on_error(){this.ws.onerror=()=>{this.vm.$data.information="发生错误, 请刷新当前页面",console.log("发生错误")}}on_message(){this.ws.onmessage=t=>{t=JSON.parse(t.data);const s=t.content;switch(console.log(t),t.type){case"start_getting":this.extend.is_running_control(this.vm,this.extend,s);break;case"next_music":this.extend.music_info_list_control(this.vm,this.extend,s),this.extend.music_url_control(this.vm,this.extend,s);try{this.extend.lyric_control(this.vm,this.extend,s)}catch(t){}setTimeout(()=>{this.extend.base_control(this.vm,this.extend,s)},2e3);break;case"play":case"who_play":case"replay":this.extend.base_control(this.vm,this.extend,s);break;case"add_music":this.extend.music_info_list_control(this.vm,this.extend,s);break;case"console_info":this.extend.console_info_control(this.vm,this.extend,s);break;case"connectivity_test_send":this.connectivity_test_panel_send(s);break;case"connectivity_test_receive":this.connectivity_test_receive(s);break;case"del_music":let e=[];s.music_info_list.forEach(t=>{e.push(t.file_name)}),vm.$data.music_info=e}}}send_formatted_ws(t,e){try{console.log(this.ws.readyState),this.ws.readyState?this.ws.send(JSON.stringify({type:t,content:e})):this.vm.$data.information="已断开连接，, 请刷新当前页面"}catch(t){this.on_close(),this.connectivity_test_panel_send(-1)}}send_heartbeat(){this.send_formatted_ws("heartbeat",{group_id:this.group_id})}start_getting(){var t={url:this.vm.$data.url,data:Number(!Boolean(vm.$data.start_flag)),where:this.vm.$data.where};this.send_formatted_ws("start_getting",t)}next_music(){var t={url:this.vm.$data.url};this.vm.$data.where?t.where=this.vm.$data.where:t.where=this.vm.$data.who_i_am?"lyric":"music",this.send_formatted_ws("next_music",t)}base_status(t,e){e={url:this.vm.$data.url,data:e,where:t,where_url:this.vm.$data.who_i_am?"lyric":"music"};this.send_formatted_ws("play",e)}play_pause(){this.vm.$data.play_icon_flag=this.vm.$data.play_icon_flag?0:1,this.base_status("play",this.vm.$data.play_icon_flag)}replay_music(){this.base_status("replay",1)}change_who_play(){var t=$("[name='switch']:eq(0)").prop("checked");this.base_status("who_play",!t)}del_music(t,e,s,i){this.send_formatted_ws("del_music",{url:t,where:e,music_name:s,artist:i})}move_music(t,e,s){t={url:this.vm.$data.url,music_name:t,artist:e,index:s};this.vm.$data.where?t.where=this.vm.$data.where:t.where=this.vm.$data.who_i_am?"lyric":"music",this.send_formatted_ws("move_music",t)}connectivity_test_console_send(){var t;void 0!==this.vm.idle_playlist_mask&&(t={url:this.vm.$data.url,random_num:this.random_num,where_url:this.vm.$data.who_i_am?"lyric":"music"},this.send_formatted_ws("connectivity_test_send",t))}connectivity_test_panel_send(t){t={url:this.vm.$data.url,random_num:t.random_num,where_url:this.vm.$data.who_i_am?"lyric":"music"};this.send_formatted_ws("connectivity_test_receive",t)}connectivity_test_receive(t){var e=$("[name='switch']:eq(0)").prop("checked");try{void 0!==t.music&&(t.music===this.random_num?document.getElementById("music_status").setAttribute("class","light status-connect"):(this.vm.$data.information="请注意歌名界面已断开连接",document.getElementById("music_status").setAttribute("class","light status-disconnect")))}catch(t){}try{void 0!==t.lyric&&(t.lyric===this.random_num?document.getElementById("lyric_status").setAttribute("class","light status-connect"):(e||(this.vm.$data.information="请注意歌词界面已断开连接"),document.getElementById("lyric_status").setAttribute("class","light status-disconnect")))}catch(t){}}}