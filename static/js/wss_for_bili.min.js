class BiliBili_WEBSocket extends WebSocket{Reader=null;constructor(t,e,r,a,i){super("wss://broadcastlv.chat.bilibili.com:443/sub"),this.vm=t,this.params=i,this.callback=a,this.extend=r,this.time_flag=!0,this.onopen=()=>{this.login(e),this.heartbeat(),this.heartbeat_id=setInterval(()=>{this.heartbeat()},2e4)},this.onmessage=t=>{this.Reader=new FileReader,this.Reader.onloadend=t=>this.new_message(t.currentTarget.result),this.Reader.readAsArrayBuffer(t.data)},this.onclose=()=>{this.vm.$data.information="连接断开"}}login(t){var t=UtilTools.str_2_uint8Array(t),e=t.length+16,r=new Array(0);console.log("预计的包长度："+e),r.push.apply(r,[0,0,255<e?1:0,e%256,0,16,0,0,0,0,0,7,0,0,0,0]),r.push.apply(r,t),e=new Uint8Array(r),console.log("握手包\n"+UtilTools.uint8Array_2_hex_str(e)),super.send(e)}heartbeat(){var t=new Uint8Array([0,0,0,18,0,16,0,1,0,0,0,2,0,0,0,1,123,125]);console.log("发送心跳包"),this.isOnlineCurrUser()?super.send(t):this.vm.$data.information="服务器连接已断开, 请刷新浏览器源"}isOnlineCurrUser(){return super.readyState===WebSocket.OPEN}new_message(t){var e=new Uint8Array(t),r=(console.log("服务器的消息\n"+UtilTools.uint8Array_2_hex_str(e)),UtilTools.decodeUtf8(t.slice(16)).trim());if(console.log(r),2!==t[7])switch(e[11]){case 3:break;case 5:var a=JSON.parse(r);if("STOP_LIVE_ROOM_LIST"===a.cmd){this.close(),clearInterval(this.heartbeat_id);const i=new Dan_mu_ku(this.vm,this.vm.$data.room_id,this.vm.$data.url,0===this.vm.$data.who_i_am?"music_url":"lyric_url");setInterval(()=>{if(this.vm.$data.who_i_am===this.vm.$data.who_play)try{i.get_dan_mu()}catch(t){this.vm.$data.information="服务器连接已断开, 请刷新浏览器源"}this.time_flag&&(this.vm.$data.information="备用弹幕服务已连接",setTimeout(()=>{this.vm.$data.now_view=0===this.vm.$data.who_i_am?"music_name":"music_lyric"},1e3),this.time_flag=!1)},3e3)}else this.callback(a,this.extend,this.params)}}}class UtilTools{static uint8Array_2_hex_str(t){return Array.prototype.map.call(t,t=>("00"+t.toString()).slice(-2)).join(" ")}static str_2_uint8Array(t){var e=[];let r=0,a=t.length;for(;r<a;++r)e.push(t.charCodeAt(r));return new Uint8Array(e)}static decodeUtf8(t){var e=this.toUint8Array(t),r=e.length;let a="";for(let t=0;t<r;t++){var i,s,n,o,l=e[t];l<128?a+=String.fromCodePoint(l):192==(224&l)?(i=63&e[++t],a+=String.fromCodePoint((31&l)<<6|i)):224==(240&l)?(i=63&e[++t],s=63&e[++t],a+=String.fromCodePoint((15&l)<<12|i<<6|s)):240==(248&l)&&(s=63&e[++t],n=63&e[++t],o=63&e[++t],a+=String.fromCodePoint((7&l)<<18|s<<12|n<<6|o))}return a}static toUint8Array(t){if(t instanceof Uint8Array)return t;if(t instanceof ArrayBuffer)return new Uint8Array(t);throw new TypeError('Expected "input" to be an ArrayBuffer or Uint8Array')}}