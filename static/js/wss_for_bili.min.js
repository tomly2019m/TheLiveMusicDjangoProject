/*
 Modify from: https://gitee.com/XL8Z/BiliBili_PlayWithMe_JS/blob/master/PlayWithMe.js
*/
class BiliBili_WEBSocket extends WebSocket {
    constructor(a, c, b, d, g) {
        super("wss://broadcastlv.chat.bilibili.com:443/sub");
        this.Reader = null;
        this.vm = a;
        this.params = g;
        this.callback = d;
        this.extend = b;
        this.time_flag = !0;
        this.onopen = () => {
            this.login(c);
            this.heartbeat();
            this.heartbeat_id = setInterval(() => {
                this.heartbeat()
            }, 2E4)
        };
        this.onmessage = e => {
            this.Reader = new FileReader;
            this.Reader.onloadend = f => this.new_message(f.currentTarget.result);
            this.Reader.readAsArrayBuffer(e.data)
        };
        this.onclose = () => {
            this.vm.$data.information =
                "\u8fde\u63a5\u65ad\u5f00"
        }
    }

    login(a) {
        a = UtilTools.str_2_uint8Array(a);
        let c = a.length + 16, b = [];
        console.log("\u9884\u8ba1\u7684\u5305\u957f\u5ea6\uff1a" + c);
        b.push.apply(b, [0, 0, 255 < c ? 1 : 0, c % 256, 0, 16, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0]);
        b.push.apply(b, a);
        a = new Uint8Array(b);
        console.log("\u63e1\u624b\u5305\n" + UtilTools.uint8Array_2_hex_str(a));
        super.send(a)
    }

    heartbeat() {
        let a = new Uint8Array([0, 0, 0, 18, 0, 16, 0, 1, 0, 0, 0, 2, 0, 0, 0, 1, 123, 125]);
        console.log("\u53d1\u9001\u5fc3\u8df3\u5305");
        this.isOnlineCurrUser() ? super.send(a) : this.vm.$data.information =
            "\u670d\u52a1\u5668\u8fde\u63a5\u5df2\u65ad\u5f00, \u8bf7\u5237\u65b0\u6d4f\u89c8\u5668\u6e90"
    }

    isOnlineCurrUser() {
        return super.readyState === WebSocket.OPEN
    }

    new_message(a) {
        let c = new Uint8Array(a);
        console.log("\u670d\u52a1\u5668\u7684\u6d88\u606f\n" + UtilTools.uint8Array_2_hex_str(c));
        let b = UtilTools.decodeUtf8(a.slice(16)).trim();
        console.log(b);
        if (2 !== a[7]) switch (c[11]) {
            case 5:
                if (a = JSON.parse(b), "STOP_LIVE_ROOM_LIST" === a.cmd) {
                    this.close();
                    clearInterval(this.heartbeat_id);
                    const d = new Dan_mu_ku(this.vm,
                        this.vm.$data.room_id, this.vm.$data.url, 0 === this.vm.$data.who_i_am ? "music_url" : "lyric_url");
                    setInterval(() => {
                        if (this.vm.$data.who_i_am === this.vm.$data.who_play) try {
                            d.get_dan_mu()
                        } catch (g) {
                            this.vm.$data.information = "\u670d\u52a1\u5668\u8fde\u63a5\u5df2\u65ad\u5f00, \u8bf7\u5237\u65b0\u6d4f\u89c8\u5668\u6e90"
                        }
                        this.time_flag && (this.vm.$data.information = "\u5907\u7528\u5f39\u5e55\u670d\u52a1\u5df2\u8fde\u63a5", setTimeout(() => {
                                this.vm.$data.now_view = 0 === this.vm.$data.who_i_am ? "music_name" : "music_lyric"
                            },
                            1E3), this.time_flag = !1)
                    }, 3E3)
                } else this.callback(a, this.extend, this.params)
        }
    }
}

class UtilTools {
    static uint8Array_2_hex_str(a) {
        return Array.prototype.map.call(a, c => ("00" + c.toString()).slice(-2)).join(" ")
    }

    static str_2_uint8Array(a) {
        const c = [];
        let b = 0, d = a.length;
        for (; b < d; ++b) c.push(a.charCodeAt(b));
        return new Uint8Array(c)
    }

    static decodeUtf8(a) {
        a = this.toUint8Array(a);
        const c = a.length;
        let b = "";
        for (let e = 0; e < c; e++) {
            let f = a[e];
            if (128 > f) b += String.fromCodePoint(f); else if (192 === (f & 224)) {
                var d = a[++e] & 63;
                b += String.fromCodePoint((f & 31) << 6 | d)
            } else if (224 === (f & 240)) {
                d = a[++e] & 63;
                var g = a[++e] &
                    63;
                b += String.fromCodePoint((f & 15) << 12 | d << 6 | g)
            } else if (240 === (f & 248)) {
                d = a[++e] & 63;
                g = a[++e] & 63;
                let h = a[++e] & 63;
                b += String.fromCodePoint((f & 7) << 18 | d << 12 | g << 6 | h)
            }
        }
        return b
    }

    static toUint8Array(a) {
        if (a instanceof Uint8Array) return a;
        if (a instanceof ArrayBuffer) return new Uint8Array(a);
        throw new TypeError('Expected "input" to be an ArrayBuffer or Uint8Array');
    }
};
